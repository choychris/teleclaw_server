"use strict";var _beforeSave=require("../utils/beforeSave"),_createLogging=require("../utils/createLogging"),_makeTransaction=require("../utils/makeTransaction"),_nodeMailer=require("../utils/nodeMailer"),request=require("request"),Promise=require("bluebird"),md5=require("md5"),_process$env=process.env,GIZWITS_APPLICATION_ID=_process$env.GIZWITS_APPLICATION_ID,GIZWITS_PRODUCT_SECRET=_process$env.GIZWITS_PRODUCT_SECRET,GIZWITS_PRODUCT_KEY=_process$env.GIZWITS_PRODUCT_KEY,app=require("../server");module.exports=function(c){function a(e,t){var n=app.models.User;return new Promise(function(r,i){n.findById(e,{include:t},function(e,t){e&&((0,_createLogging.loggingFunction)("Machine | ","findUserInclude error | ",e,"error"),i(e));var n=t.toJSON();r(n)})})}function T(r,i){a(r,{relation:"userIdentities",scope:{limit:1}}).then(function(e){var t=e.userIdentities[0].picture?e.userIdentities[0].picture.url:"https://scontent.xx.fbcdn.net/v/t1.0-1/c15.0.50.50/p50x50/10354686_10150004552801856_220367501106153455_n.jpg?_nc_cat=0&oh=3f6c91428fc256182541f697d6bb84d3&oe=5B3B0A2F",n={id:r,name:e.name,picture:t};return y(i,{status:"playing",currentUser:n}),null}).catch(function(e){(0,_createLogging.loggingFunction)("Machine | ","updateCurrentUser error | ",e,"error")})}function y(e,n){c.findById(e,function(e,t){t.updateAttributes(n)})}(0,_createLogging.loggingModel)(c),(0,_beforeSave.assignKey)(c),(0,_beforeSave.updateTimeStamp)(c),c.observe("before save",function(e,t){if(e.isNewInstance)e.instance.iotPlatform||(e.instance.iotPlatform={gizwits:{}}),e.instance.currentUser=null,t();else{if(e.data){var n=e.data,r=n.status,i=n.sku,a=n.reservation,o=n.productId,s=e.currentInstance.status;if(!r||a||o){if(a&&!o)e.hookState.pusher=!0;else if(i<=0)e.hookState.pusher=!0,e.data.status="close",e.data.currentUser=null;else if(i<=3){var u=e.currentInstance,c=u.id,d=u.name,l="Machine "+d+" sku is below threhold",p="<h3>Machine name : "+d+"</h3>\n              <p>Machine id: "+c+"</p>\n              <p>Product id: "+e.currentInstance.productId+"</p>\n              <p>This machine sku is now at <strong><em>"+i+"</em></strong></p>\n              <p>Please refill or restock</p>";(0,_nodeMailer.sendEmail)(l,p)}}else"open"===r&&"close"===s&&(e.hookState.resume=!0),e.hookState.pusher=!0,e.hookState.lastStatusChanged=!0,e.data.lastStatusChanged=(new Date).getTime()}t()}}),c.observe("after save",function(e,t){if(e.isNewInstance)t();else{var n=e.instance,r=n.id,i=n.status,a=n.currentUser,o=n.productId,s=n.reservation,u=a||null;if(e.hookState&&e.hookState.pusher){if(!0===e.hookState.resume)app.models.Reservation.endEngage(r,"null",null);app.pusher.trigger("presence-machine-"+r,"machine_event",{status:i,reservation:s,currentUser:u,lastUpdated:(new Date).getTime()})}e.hookState&&e.hookState.lastStatusChanged&&function(n){var t=app.models.Product;function r(r,e){t.findById(e,function(e,t){var n=t.status;r?(n.machineStatus=r,n.maintainStatus=!1):n.machineStatus=r,t.updateAttributes({status:n})})}c.find({where:{productId:n,status:"open",currentUser:null}},function(e,t){0!==t.length?r(!0,n):r(!1,n)})}(o),t()}}),c.gamePlay=function(e,m,t,b){e.setTimeout(24e4);var _=t.productId,v=t.userId,n=app.models,r=n.Product,d=n.Play,P=n.User,i={userId:v,machineId:m,productId:_,timeStamp:new Date};(0,_createLogging.loggingFunction)("Machine | ","gamePlay Remote | ",JSON.stringify(i),"info");var l={};function w(r,i,a,e,o,t){var _,v,w,S,n,s=t.deviceMAC,u=t.deviceId,c=t.heartbeat_interval;Promise.all([(_=r,v=i,w=s,S=u,n={method:"POST",url:"http://api.gizwits.com/app/users",headers:{"X-Gizwits-Application-Id":GIZWITS_APPLICATION_ID},body:JSON.stringify({phone_id:_})},new Promise(function(I,m){request(n,function(f,h){P.find({where:{id:_,bindedDevice:S}},function(e,t){var n=JSON.parse(h.body),r=n.token,i=n.uid;if(f||e||!h.body||!r||!i)return(0,_createLogging.loggingFunction)("Machine | ","login gizwits user error | ",f||e,"error"),m(f||e||new Error("bad response from gizwits"));var a,o,s,u,c,d,l,p,g={init:{appid:GIZWITS_APPLICATION_ID,uid:i,token:r,p0_type:"attrs_v4",auto_subscribe:!1},control:{did:S}};if(0!==t.length)return I(g);a=w,o=r,s=v,u=g,c=I,d=m,l=Math.round((new Date).getTime()/1e3),p={method:"POST",url:"http://api.gizwits.com/app/bind_mac",headers:{"X-Gizwits-Application-Id":GIZWITS_APPLICATION_ID,"X-Gizwits-Timestamp":l,"X-Gizwits-Signature":md5(GIZWITS_PRODUCT_SECRET+l),"X-Gizwits-User-token":o},body:JSON.stringify({product_key:GIZWITS_PRODUCT_KEY,mac:a})},request(p,function(e,t){var n=JSON.parse(t.body),r=n.host,i=n.wss_port;if(!e&&t.body&&r){var a={"iotPlatform.gizwits.host":r,"iotPlatform.gizwits.wss_port":i};y(s,a),u.websocket={host:r,wss_port:i},c(u)}else(0,_createLogging.loggingFunction)("Machine | ","gizwits bind mac error | ",e,"error"),d(e||new Error("bad response from gizwits"))}),P.update({id:_},{$push:{bindedDevice:S}},{allowExtendedOperators:!0})})})})),(0,_makeTransaction.createNewTransaction)(r,e,"play","minus",!0)]).then(function(e){var t=e[1].id,n=o.result;return(l={newWalletBalance:e[1].newWalletBalance,gizwits:e[0],userId:r}).gizwits.control.InitCatcher=o.initCatcher,l.gizwits.init.heartbeat_interval=c,d.create({userId:r,machineId:i,productId:a,transactionId:t,expectedResult:n})}).then(function(e){l.playId=e.id,b(null,l)}).catch(function(e){(0,_createLogging.loggingFunction)("Machine | ","start game function error | ",e,"error"),d.create({userId:r,machineId:i,productId:a,transactionId:"system error",expectedResult:!1}).then(function(e){b(null,{playId:e.id,userId:r,gizwits:"no response"})})})}Promise.all([a(v,"wallet"),c.findById(m),r.findById(_)]).then(function(e){var t,n,r,i,a=e[0].wallet.balance,o=e[1],s=o.status,u=o.currentUser,c=o.iotPlatform,d=c.gizwits.init,l=e[2],p=l.gamePlayRate,g=l.productRate,f=!!u&&u.id==v;if("open"!==s||u)if("close"!==s&&f)if(p<=a){var h=S(g,d);w(v,m,_,p,h,c.gizwits),u.name?y(m,{status:"playing"}):T(v,m)}else b(null,"insufficient_balance");else"close"!==s?(t=v,n=m,r=_,i=app.models.Reservation,new Promise(function(c,d){i.findOne({where:{userId:t}},function(u,e){e.updateAttributes({status:"open",machineId:n,productId:r},function(e,t){(u||e)&&((0,_createLogging.loggingFunction)("Machine | ","makeReserve error | ",u||e,"error"),d(u||e));var n=t.id,r=t.status,i=t.machineId,a=t.productId,o=t.lastUpdated,s={id:n,status:r,machineId:i,productId:a,lastUpdated:o};c(s)})})})).then(function(e){return b(null,{reservation:e}),null}):b(null,"machine_closed");else if(p<=a){var I=S(g,d);w(v,m,_,p,I,c.gizwits),T(v,m)}else b(null,"insufficient balance");return null}).catch(function(e){(0,_createLogging.loggingFunction)("Machine | ","initialize game play error | ",e,"error"),b(e)});var S=function(e,t){function n(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}var r=n(1,e),i=n(1,e);return{initCatcher:r===i?t.concat([1,1]):t.concat([0,1]),result:r===i}}},c.afterRemote("gamePlay",function(e,t,n){if(void 0!==e.result.result.gizwits){var r=e.result.result,i=(r.userId,r.playId);setTimeout(function(){!function(e,t){var n=app.models,r=n.Play;n.Transaction;r.findById(e,function(e,t){if(void 0===t.finalResult){var n={ended:(new Date).getTime(),finalResult:!1,systemUpdate:!0};t.updateAttributes(n)}})}(i)},7e4),n()}else n()}),c.remoteMethod("gamePlay",{http:{path:"/:machineId/gamePlay",verb:"post"},accepts:[{arg:"req",type:"object",http:{source:"req"}},{arg:"machineId",type:"string",required:!0},{arg:"data",type:"object",required:!0}],returns:{arg:"result",type:"object"}})};