"use strict";var _beforeSave=require("../utils/beforeSave"),_createLogging=require("../utils/createLogging"),request=require("request"),Promise=require("bluebird"),_process$env=process.env,FB_APP_SECRET=_process$env.FB_APP_SECRET,FB_CLIENT_ID=_process$env.FB_CLIENT_ID,app=require("../server");module.exports=function(p){delete p.validations.email,p.disableRemoteMethodByName("login"),(0,_createLogging.loggingModel)(p),(0,_beforeSave.updateTimeStamp)(p),p.observe("before save",function(e,r){e.isNewInstance?(e.instance.referral={code:function(){for(var e=(new Date).getTime(),r="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n=0;n<3;n+=1)e+=r.charAt(Math.floor(Math.random()*r.length));return e.slice(5)}(),isReferred:!1,numOfReferred:0},e.instance.bindedDevice=[],e.instance.address={},e.instance.status=!0,e.instance.preference={sound:!0,vibration:!0}):e.data&&void 0!==e.data.lastLogIn&&(e.data.lastLogIn=(new Date).getTime()),r()}),p.observe("after save",function(o,i){if(o.isNewInstance){var e=app.models,r=e.Event,a=e.Wallet,s=e.Reservation;r.findOne({where:{launching:!0,type:"signUp"},order:"startTime DESC"},function(e,r){e&&((0,_createLogging.loggingFunction)("User | ","Event.findOne error | ",e,"error"),i(e));var n={balance:r?r.rewardAmount:0,ticket:0,userId:o.instance.id},t={status:"close",userId:o.instance.id,machineId:null,productId:null};a.create(n),s.create(t)})}i()}),p.auth=function(s,u){var e,r=app.models,g=r.UserIdentity,d=r.Role,l=r.Rolemap;function c(r){if(r.accessToken&&r.username&&r.userId)(e=r,n=e.userId,i=e.username,a=e.accessToken,s=e.picture,c=e.email,new Promise(function(t,o){g.findById(n,function(e,r){if(e)(0,_createLogging.loggingFunction)("User | ","find identity error | ",e,"error"),o(e);else if(null===r)t(!1);else{var n=s?s.data:{width:50,height:50,url:"https://scontent.xx.fbcdn.net/v/t1.0-1/c15.0.50.50/p50x50/10354686_10150004552801856_220367501106153455_n.jpg?_nc_cat=0&oh=3f6c91428fc256182541f697d6bb84d3&oe=5B3B0A2F",is_silhouette:!0};r.updateAttributes({username:i,email:c,picture:n,accesstoken:a},function(e){e&&((0,_createLogging.loggingFunction)("User | ","update user identity error | ",e,"error"),o(e))}),t(!0)}})})).then(function(e){var a,s,c;return e?t({ttl:r.expiresIn,username:r.userId+"@teleclaw",password:r.userId},r,!1):(a=r,s=a.picture?a.picture.data:{width:50,height:50,url:"https://scontent.xx.fbcdn.net/v/t1.0-1/c15.0.50.50/p50x50/10354686_10150004552801856_220367501106153455_n.jpg?_nc_cat=0&oh=3f6c91428fc256182541f697d6bb84d3&oe=5B3B0A2F",is_silhouette:!0},c={lastLogIn:1e4,name:a.username,username:a.userId+"@teleclaw",contactEmail:a.email||null,password:a.userId,language:a.language,picture:s.url},new Promise(function(o,i){p.create(c,function(e,t){e&&((0,_createLogging.loggingFunction)("User | ","create user error | ",e,"error"),i({type:"create user error",error:e}));var r={id:a.userId,userId:t.id,provider:"facebook",username:a.username,email:a.email||null,picture:s,accesstoken:a.accessToken};g.create(r,function(e,r){e&&((0,_createLogging.loggingFunction)("User | ","create identity error | ",e,"error"),i({type:"create identity error",error:e}))}),d.findOne({where:{name:"user"}},function(e,r){var n=r.id;l.create({principalType:"USER",principalId:t.id,roleId:n})}),(0,_createLogging.loggingFunction)("User | ","User sign Up Success| ",a.username,"info");var n={ttl:a.expiresIn,username:a.userId+"@teleclaw",password:c.password};o(n)})})).then(function(e){return t(e,r,!0)})}).then(function(e){u(null,e)}).catch(function(e){(0,_createLogging.loggingFunction)("User | ","checkExistThenLogin error | ",e,"error"),u(e)});else{u({type:"authentication error",message:"required info missing",status:401})}var e,n,i,a,s,c}function t(e,o,i){return new Promise(function(n,t){p.login(e,function(e,r){e?((0,_createLogging.loggingFunction)("User | ","user login error | ",e,"error"),t({loginError:e})):((0,_createLogging.loggingFunction)("User | ","user login | ","logIn success : "+r.userId),n({newUser:i,lbToken:r,fbToken:o.accessToken,ttl:o.expiresIn}))})})}(e=s.accessToken,new Promise(function(o,i){request("https://graph.facebook.com/debug_token?input_token="+e+"&access_token="+FB_CLIENT_ID+"|"+FB_APP_SECRET,function(e,r,n){if(e)return(0,_createLogging.loggingFunction)("User | ","fb check token valid api error | ",e,"error"),i(e),!1;var t=JSON.parse(n);return void 0!==t.error?((0,_createLogging.loggingFunction)("User | ","fb check token valid api error | ",t.error,"error"),i(t.error.message),!1):t.data.is_valid&&t.data.expires_at>(new Date).getTime()/1e3?o(!0):i(new Error("invalid token from facebook"))})})).then(function(){return s.accessToken&&s.expiresIn&&s.expiresIn<1e4?request("https://graph.facebook.com/oauth/access_token?grant_type=fb_exchange_token&client_id="+FB_CLIENT_ID+"&client_secret="+FB_APP_SECRET+"&fb_exchange_token="+s.accessToken,function(e,r,n){if(e){(0,_createLogging.loggingFunction)("User | ","exchange long live token error | ",e,"error");u({message:"Request from facebook error",status:401})}var t=JSON.parse(n);if(t.error){(0,_createLogging.loggingFunction)("User | ","exchange long live token error | ",t.error,"error");var o={message:t.error.message,status:401};u(o)}var i=t.access_token,a=(t.token_type,t.expires_in);s.accessToken=i,s.expiresIn=a,c(s)}):c(s),null}).catch(function(e){u({message:e,status:401})})},p.remoteMethod("auth",{accepts:{arg:"userInfo",type:"object",http:{source:"body"}},returns:{arg:"result",type:"object"}}),p.createAdmin=function(e,r){var n=app.models,t=n.Role,o=n.Rolemap,i=e.username,a=e.password;t.findOne({where:{name:"teleClawAdmin"}}).then(function(e){return[p.create({username:i,password:a,admin:!0}),e]}).spread(function(e,r){return o.create({principalType:"USER",principalId:e.id,roleId:r.id})}).then(function(e){r(null,"create admin success")}).catch(function(e){(0,_createLogging.loggingFunction)("User | ","create admin error | ",e,"error"),r(e)})},p.remoteMethod("createAdmin",{http:{path:"/createAdmin",verb:"post"},accepts:{arg:"info",type:"object",http:{source:"body"}},returns:{arg:"result",type:"string"}}),p.loginAdmin=function(e,r){var n=app.models,t=(n.Role,n.Rolemap,e.username),o=e.password,i=e.ttl||123e4;p.findOne({where:{username:t}}).then(function(e){return e&&e.admin?p.login({username:t,password:o,ttl:i}):"authorization_required"}).then(function(e){r(null,e)}).catch(function(e){(0,_createLogging.loggingFunction)("User | ","Login admin error |",e,"error"),r(e)})},p.remoteMethod("loginAdmin",{http:{path:"/loginAdmin",verb:"post"},accepts:{arg:"info",type:"object",http:{source:"body"}},returns:{arg:"response",type:"object"}}),p.pusherAuth=function(i,e,a,r){var n=e.body,s=n.socket_id,c=n.channel_name,u=app.pusher;app.models.UserIdentity.findOne({where:{userId:i}},function(e,r){if(null!==r){var n=r.picture?r.picture.url:"https://scontent.xx.fbcdn.net/v/t1.0-1/c15.0.50.50/p50x50/10354686_10150004552801856_220367501106153455_n.jpg?_nc_cat=0&oh=3f6c91428fc256182541f697d6bb84d3&oe=5B3B0A2F",t={user_id:i,user_info:{name:r.username,picture:n}},o=u.authenticate(s,c,t);a.send(o)}})},p.remoteMethod("pusherAuth",{http:{path:"/:id/pusherAuth",verb:"post"},accepts:[{arg:"id",type:"string",required:!0},{arg:"req",type:"object",http:{source:"req"}},{arg:"res",type:"object",http:{source:"res"}}]})};