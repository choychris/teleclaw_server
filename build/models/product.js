"use strict";var _beforeSave=require("../utils/beforeSave"),_createLogging=require("../utils/createLogging"),_nodeMailer=require("../utils/nodeMailer"),storage=require("../utils/multerStorage"),cloudinary=require("cloudinary"),multer=require("multer"),Promise=require("bluebird"),app=require("../server");module.exports=function(e){function u(u,c,d){var e=app.models,a=e.Benchmark,t=e.ExchangeRate,r=u[c].benchmarkId||u.currentInstance.benchmarkId,n="data"===c?u.data.cost||u.currentInstance.cost:u[c].cost,l=n?n.value:1;Promise.all([a.findById(r),t.findOne({where:{status:!0},order:"realValuePerCoin.hkd ASC"})]).then(function(e){var a=e[0],t=a.marginRate,r=a.overheadCost,n=a.gamePlayRate,o=e[1].realValuePerCoin,i=l*t*r,s=n*o.hkd;return u[c].productRate=Math.round(i/s)||0,u[c].gamePlayRate=n,d(),null}).catch(function(e){(0,_createLogging.loggingFunction)("Product | "," attachBenchmark Error | ",e,"error"),d()})}(0,_createLogging.loggingModel)(e),(0,_beforeSave.updateTimeStamp)(e),(0,_beforeSave.assignKey)(e),e.observe("before save",function(e,a){if(e.instance&&e.instance.benchmarkId)u(e,"instance",a);else if(e.data&&(e.data.benchmarkId||e.data.cost))u(e,"data",a);else if(e.data&&e.data.machines)e.hookState.machines=e.data.machines,delete e.data.machines,a();else if(e.data&&e.data.status)e.hookState.statusChange=!0,a();else if(e.data&&e.data.sku<=0){var t=e.currentInstance.status;t.maintainStatus=!0,e.hookState.statusChange=!0,e.data.status=t,a()}else if(e.data&&e.data.sku){if(e.data.sku<=5){var r=e.currentInstance,n=r.name,o=r.id,i="Product "+n.en+" sku is below threhold",s="<h3>Product name : "+n.en+"</h3>\n            <p>Product id: "+o+"</p>\n            <p>This product sku is now at <em><strong>"+e.data.sku+"</strong></em></p>\n            <p>Please refill or restock</p>";(0,_nodeMailer.sendEmail)(i,s)}a()}else a()}),e.observe("after save",function(e,a){if(!e.isNewInstance&&e.hookState&&e.hookState.statusChange){var t=e.instance,r=t.id,n=t.status;app.pusher.trigger("products","statusChange",{productId:r,status:n,lastUpdated:(new Date).getTime()})}a()}),e.observe("after save",function(a,t){if(a.isNewInstance)t();else if(a.hookState&&a.hookState.machines){var r=app.models.Machine;Promise.mapSeries(a.hookState.machines,function(e){e.productId=a.instance.id,r.upsert(e,function(e){e&&((0,_createLogging.loggingFunction)("Product | "," Machine.updsert Error | ",e,"error"),t(e))})}).then(function(){t()}).catch(function(e){(0,_createLogging.loggingFunction)("Product | "," Machine.updsert Error | ",e,"error"),t(e)})}else t()}),e.imageUpload=function(o,i,s){var e=process.env,a=e.CLOUDINARY_CLOUD_NAME,t=e.CLOUDINARY_API_KEY,r=e.CLOUDINARY_API_SECRET;cloudinary.config({cloud_name:a,api_key:t,api_secret:r}),multer({storage:storage}).single("tempImage")(o,i,function(e){if(e)(0,_createLogging.loggingFunction)("Product | "," multer upload Error | ",e,"error"),i.end(e);else{var a=o.body,t=a.name,r=a.tag,n=a.placement;cloudinary.image(o.file.path,{quality:"auto"}),cloudinary.v2.uploader.upload(o.file.path,{public_id:n,folder:t,tags:[r]},function(e,a){e&&(0,_createLogging.loggingFunction)("Product | "," cloudinary upload Error | ",e,"error"),s(null,a.secure_url)})}})},e.remoteMethod("imageUpload",{accepts:[{arg:"req",type:"object",http:{source:"req"}},{arg:"res",type:"object",http:{source:"res"}}],returns:{arg:"imageUrl",type:"string"}})};