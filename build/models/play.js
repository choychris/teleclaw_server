"use strict";var _beforeSave=require("../utils/beforeSave"),_createLogging=require("../utils/createLogging"),_gamePlayTimer=require("../utils/gamePlayTimer"),_makeTransaction=require("../utils/makeTransaction"),shortid=require("shortid"),app=require("../server");module.exports=function(t){(0,_createLogging.loggingModel)(t),(0,_createLogging.loggingRemote)(t,"refund"),(0,_beforeSave.updateTimeStamp)(t),t.observe("before save",function(e,t){if(e.isNewInstance)e.instance.id=shortid.generate(),t();else{if(e.data&&e.data.ended&&void 0!==e.data.finalResult){var n=app.models,a=n.Machine,r=n.Reservation,i=n.Product,u=n.Prize,d=e.currentInstance,o=d.productId,c=d.machineId,s=d.userId,l=d.created;a.findById(c,function(e,t){t.updateAttributes({status:"open"})});var g=(new Date(e.data.ended).getTime()-new Date(l).getTime())/1e3;e.data.duration=g,!0===e.data.finalResult&&(e.data.deliveryId="transferred",u.create({userId:s,productId:o,status:"normal"}),(0,_makeTransaction.makeCalculation)(i,o,"sku",1,"minus")),e.data.errorRefund||setTimeout(function(){(0,_gamePlayTimer.checkMachineStatus)(c,s,a,r)},12e3)}t()}}),t.refund=function(a,r){var e=app.models,i=e.Reservation,u=e.Transaction,d=e.Machine;t.findOne({where:{userId:a},order:"created DESC"}).then(function(e){return(new Date).getTime()-new Date(e.created).getTime()<=8e4?(t=e.machineId,n=a,d.findById(t).then(function(e){return e.updateAttributes({status:"open"})}).then(function(){i.endEngage(t,n,null)}).catch(function(e){(0,_createLogging.loggingFunction)("Play | ","Update machine in Play refund Error | ",e,"error"),r(e)}),e.updateAttributes({errorRefund:!0,finalResult:!1,ended:(new Date).getTime()}),u.findById(e.transactionId)):(r(null,"refund_fail"),null);var t,n}).then(function(e){return null!=e?(0,_makeTransaction.createNewTransaction)(a,e.amount,"refund","plus",!0):null}).then(function(e){null!=e&&r(null,{newWalletBalance:e.newWalletBalance})}).catch(function(e){(0,_createLogging.loggingFunction)("Play | "," Play refund Error | ",e,"error"),r(e)})},t.remoteMethod("refund",{http:{path:"/:userId/refund",verb:"get"},accepts:[{arg:"userId",type:"string",required:!0}],returns:{arg:"result",type:"object"}})};