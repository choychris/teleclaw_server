"use strict";var _beforeSave=require("../utils/beforeSave"),_createLogging=require("../utils/createLogging"),_makeTransaction=require("../utils/makeTransaction"),moment=require("moment"),Promise=require("bluebird"),app=require("../server");module.exports=function(g){(0,_createLogging.loggingModel)(g),(0,_createLogging.loggingRemote)(g,"checkIn"),(0,_createLogging.loggingRemote)(g,"refer"),(0,_beforeSave.updateTimeStamp)(g),(0,_beforeSave.assignKey)(g),g.observe("before save",function(r,n){if(r.isNewInstance){var e=r.instance,t=e.type,a=e.rewardAmount,o=e.userId;(0,_makeTransaction.createNewTransaction)(o,a,t,"plus",!0).then(function(e){return r.instance.transactionId=e.id,n(),null}).catch(function(e){n(e)})}else n()}),g.checkIn=function(t,a){var e=app.models,r=e.User,n=e.Event,o=e.Wallet,i=moment().startOf("day").valueOf(),u=moment().endOf("day").valueOf();r.findById(t,{fields:{lastLogIn:!0}}).then(function(e){var r=moment(e.lastLogIn).valueOf();return i<r&&r<u?((0,_createLogging.loggingFunction)("Reward | ","checkIn reward | reward_already_claimed",{userId:t},"info"),a(null,"reward_already_claimed")):n.findOne({where:{launching:!0,type:"checkIn"}})}).then(function(e){if(null==e)return null;var r=e.type,n=e.rewardAmount;return Promise.all([o.findOne({where:{userId:t}}),g.create({type:r,rewardAmount:n,userId:t})])}).then(function(e){if(e){var r=e[0],n=e[1];a(null,{success:!0,rewardAmount:n.rewardAmount,newWalletBalance:r.balance+n.rewardAmount})}}).catch(function(e){(0,_createLogging.loggingFunction)("Reward | "," checkIn reward Error | ",e,"error"),a(e)})},g.afterRemote("checkIn",function(e,r,t){var a=e.args.userId,n=app.models,o=n.Play,i=n.Prize;o.find({where:{userId:a,finalResult:!0}},function(e,r){if(0<r.length){var n=r.filter(function(e){return void 0===e.deliveryId});0<n.length&&Promise.map(n,function(e){return e.updateAttributes({deliveryId:"transferred"}),i.create({userId:a,productId:e.productId,status:"normal"})}).then(function(){}).catch(function(e){(0,_createLogging.loggingFunction)("Reward | ","checkin plays transit | ",e,"error")})}t()})}),g.remoteMethod("checkIn",{http:{path:"/checkIn/:userId",verb:"get"},accepts:{arg:"userId",type:"string",required:!0},returns:{arg:"result",type:"object"}}),g.refer=function(e,d){var l=e.userId,o=e.code?e.code.trim():null,r=app.models,i=r.User,u=r.Event,c=r.Wallet;null===o?d(null,"missingCode"):Promise.all([i.findOne({where:{"referral.code":o}}),u.findOne({where:{type:"promotion",launching:!0,code:o}})]).then(function(e){var r,n,t=e[0],a=e[1];return null!==t?(n=t,i.findById(l).then(function(e){return e.referral.code===o?((0,_createLogging.loggingFunction)("Reward | ","referFriends | ","invalidCode","info"),d(null,"invalidCode")):e.referral.isReferred?((0,_createLogging.loggingFunction)("Reward | ","referFriends | ","alreadyReferred","info"),d(null,"alreadyReferred")):Promise.all([u.findOne({where:{type:"referral",launching:!0}}),n,e])}).then(function(e){if(null==e)return null;var r=e[0],n=e[1],t=e[2],a=r.type,o=r.rewardAmount,i=r.maxNum;if(null!==i&&n.referral.numOfReferred>=i)return(0,_createLogging.loggingFunction)("Reward | ","referFriends | ","maxRefer","info"),d(null,"maxRefer"),null;var u=n.referral;return t.updateAttributes({"referral.isReferred":!0}),n.updateAttributes({"referral.numOfReferred":u.numOfReferred+1}),Promise.all([c.findOne({where:{userId:l}}),g.create({type:a,rewardAmount:o,userId:l,participantId:n.id}),g.create({type:a,rewardAmount:o,userId:n.id,participantId:l})])}).then(function(e){if(e){var r=e[0],n=e[1];d(null,{success:!0,rewardAmount:n.rewardAmount,newWalletBalance:r.balance+n.rewardAmount})}}).catch(function(e){(0,_createLogging.loggingFunction)("Reward | ","referFriend promise chain error | ",e,"error"),d(e)})):null!==a?(r=a,u.find({where:{claimedUser:{in:[l]},type:"promotion",launching:!0,code:o}}).then(function(e){return 0!==e.length?((0,_createLogging.loggingFunction)("Reward | ","promotionCode | ","rewardClaimed","info"),d(null,"rewardClaimed")):r}).then(function(e){if(void 0!==e){var r=(new Date).getTime();if(null!==e.maxNum&&e.maxNum<=e.currentNum)(0,_createLogging.loggingFunction)("Reward | ","promotionCode | ","eventFull","info"),d(null,"eventFull");else{if(!(r>e.endTime)){var n=e.id,t=e.currentNum,a=e.rewardAmount,o=e.type;return e.updateAttributes({currentNum:t+1}),u.update({id:n},{$push:{claimedUser:l}},{allowExtendedOperators:!0}),Promise.all([c.findOne({where:{userId:l}}),g.create({type:o,rewardAmount:a,userId:l})])}(0,_createLogging.loggingFunction)("Reward | ","promotionCode | ","eventEnded","info"),d(null,"eventEnded")}}return null}).then(function(e){if(e){var r=e[0],n=e[1];d(null,{success:!0,rewardAmount:n.rewardAmount,newWalletBalance:r.balance+n.rewardAmount})}}).catch(function(e){(0,_createLogging.loggingFunction)("Reward | ","promotionCode promise chain error | ",e,"error"),d(e)})):((0,_createLogging.loggingFunction)("Reward | ","find code in user or event | ","invalidCode","info"),d(null,"invalidCode")),null}).catch(function(e){(0,_createLogging.loggingFunction)("Reward | ","Promise.all check reward type error | ",e,"error"),d(e)})},g.remoteMethod("refer",{http:{path:"/refer",verb:"post"},accepts:{arg:"data",type:"object",required:!0},returns:{arg:"result",type:"object"}}),g.rewardedVideo=function(e,r){var n=e.userId,t=e.method;app.models.Event.findOne({where:{type:"videoAds",launching:!0}}).then(function(e){return"get"===t?r(null,{amount:e.rewardAmount}):"claim"===t&&((0,_createLogging.loggingFunction)("Reward | ","rewardedVideo claim | user:",n,"info"),g.create({type:"videoAds",rewardAmount:e.rewardAmount,userId:n}).then(function(){r(null,{success:!0,rewardAmount:e.rewardAmount})})),null}).catch(function(e){(0,_createLogging.loggingFunction)("Reward | ","rewardedVideo promise chain error | ",e,"error"),r(e)})},g.remoteMethod("rewardedVideo",{http:{path:"/rewardedVideo",verb:"post"},accepts:{arg:"data",type:"object",http:{source:"body"}},returns:{arg:"response",type:"object"}})};